<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>âœ… To Do List (Pyodide)</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    html, body { height:100%; margin:0; }
    body {
      background:#000; color:#fff; font-family:"Courier New",monospace;
      font-size:0.9em; overflow:hidden; cursor:none;
    }
    #terminal { display:flex; flex-direction:column; height:100%; padding:6px 20px; box-sizing:border-box; }
    #header { white-space:pre-wrap; margin-bottom:1em; text-align:left; }
    #output { flex:1 1 auto; white-space:pre-wrap; overflow-y:auto; scrollbar-width:none; width:98%; }
    #output::-webkit-scrollbar { display:none; }
    #input-line { flex:0 0 auto; display:flex; align-items:center; border-top:1px solid #222; margin-top:10px; padding-top:10px; }
    #prompt { margin-right:6px; }
    #command { outline:none; white-space:pre; caret-color:transparent; display:inline-block; min-width:1ch; }
    #command:empty::before { content:" "; color:#000; } /* invisible baseline placeholder */
    #command::after {
      content:""; display:inline-block; width:8px; height:1em; background:#fff;
      animation:blink 1s steps(1) infinite; vertical-align:bottom;
    }
    @keyframes blink { 50% { background:transparent; } }
  </style>
</head>
<body>
  <div id="terminal">
    <div id="header"></div>
    <div id="output">
Welcome to To Do List  

Options:  

1. Add Task  

2. Remove Task  

3. Quit  

Enter Your Choice, 1, 2, or 3       
    </div>
    <div id="input-line">
      <span id="prompt">>>> </span>
      <span id="command" contenteditable="true"></span>
    </div>
  </div>

  <!-- Python logic runs inside Pyodide -->
  <script id="py-code" type="text/plain">
_output = []
def py_print(*args):
    _output.append(" ".join(str(a) for a in args))

def flush_output():
    s = "\n".join(_output)
    _output.clear()
    return s

todo_list = []

def add_task(task):
    todo_list.append(task)
    py_print(f"Task '{task}' added")

def remove_task():
    if todo_list:
        removed = todo_list.pop()
        py_print(f"Task '{removed}' removed")
    else:
        py_print("Your To Do List is empty")
  </script>

  <script>
    // Elements
    const cmdEl = document.getElementById("command");
    const outEl = document.getElementById("output");

    // Sticky-bottom output
    let autoStick = true;
    function atBottom() {
      return Math.abs(outEl.scrollHeight - outEl.scrollTop - outEl.clientHeight) < 4;
    }
    function append(txt) {
      outEl.textContent += txt;
      if (autoStick) outEl.scrollTop = outEl.scrollHeight;
    }
    outEl.addEventListener("scroll", () => { autoStick = atBottom(); });

    // Sanitize contenteditable quirks
    function sanitize(raw) {
      return raw
        .replace(/[\u200B\u200C\u200D]/g, "") // zero-width
        .replace(/\u00A0/g, " ")             // non-breaking space
        .replace(/\r?\n/g, "")               // stray newlines
        .trim();
    }

    // Pyodide init
    let pyReady = false;
    let pyodide;
    async function initPyodide() {
      pyodide = await loadPyodide();
      await pyodide.runPython(document.getElementById("py-code").textContent);
      pyReady = true;
      flushQueue();
    }

    // Call Python and get fresh buffered output
    function runPy(code) {
      // In Pyodide, runPython returns the last expression value.
      // We chain flush_output() to return a fresh string each time.
      return pyodide.runPython(code);
    }
    function addTask(task) {
      return runPy(`add_task(${JSON.stringify(task)}); flush_output()`);
    }
    function removeTask() {
      return runPy(`remove_task(); flush_output()`);
    }

    // Menu text to reprint after Quit (no welcome)
    const MENU_TEXT = `

Options:  

1. Add Task  

2. Remove Task  

3. Quit  

Enter Your Choice, 1, 2, or 3       `;

    // Command state
    let awaitingTask = false;
    function isMenuCommand(c) {
      return ["1","2","3","help","credits","license","copyright"].includes(c);
    }

    // Queue commands until Pyodide is ready
    const queue = [];
    function enqueue(raw) { queue.push(raw); }
    function flushQueue() {
      while (queue.length) {
        const raw = queue.shift();
        processCommand(raw, /*echo*/ false);
      }
    }

    // Core processor (can echo or not)
    function processCommand(raw, echo = true) {
      const original = sanitize(raw);
      const low = original.toLowerCase();

      if (echo) append(`\n>>> ${original}\n\n`);
      if (!low) return;

      // Menu commands have priority
      if (isMenuCommand(low)) {
        awaitingTask = false;

        if (low === "1") {
          append("Enter task");
          awaitingTask = true;
          return;
        }
        if (low === "2") {
          append(removeTask());
          return;
        }
        if (low === "3") {
          // Clear list and reprint menu, no welcome
          pyodide.runPython("todo_list.clear()");
          append("Your To Do List is empty" + MENU_TEXT);
          return;
        }
        if (low === "help") {
          append("Type the number of an option to execute it.\n\n1 = Add a task\n2 = Remove the last task\n3 = Quit the program");
          return;
        }
        if (low === "credits") {
          append("This was originally created on Mimo.");
          return;
        }
        if (low === "license") {
          append("Python is distributed under the PSF License.\nSee https://docs.python.org/3/license.html for details.");
          return;
        }
        if (low === "copyright") {
          append("Copyright (c) 2001-2025 Python Software Foundation.\nAll Rights Reserved.");
          return;
        }
      }

      // If we were prompted to add a task, and the input isn't a command, treat it as the task name
      if (awaitingTask) {
        const task = original; // preserve original casing/spaces
        append(addTask(task));
        awaitingTask = false;
        return;
      }

      // Anything else is invalid
      append("Input not recognized, please type a valid input");
    }

    // Public entrypoint: handles readiness and echo
    function runCommand(raw) {
      if (!pyReady) {
        append(`\n>>> ${sanitize(raw)}\n\n`);
        enqueue(raw);
        return;
      }
      processCommand(raw, /*echo*/ true);
    }

    // Input handling
    function normalize() { if (cmdEl.innerText === "") cmdEl.textContent = ""; }
    cmdEl.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const raw = cmdEl.innerText;
        cmdEl.textContent = ""; // seamless prompt
        runCommand(raw);
      }
    });
    cmdEl.addEventListener("input", normalize);

    // Header (permanent info like Pyodide)
    function formatDate() {
      const n = new Date();
      return `${n.toDateString()} ${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;
    }
    function updateHeader() {
      document.getElementById("header").textContent =
`Python 3.15.0 (main, ${formatDate()}) [Clang 14.0.0]
Type "help", "credits", "license", "copyright"
for more information.`;
    }
    updateHeader();
    setInterval(updateHeader, 60000);

    // Init + focus
    window.addEventListener("load", () => {
      normalize();
      cmdEl.focus();
      initPyodide();
    });

    // Hidden mouse trick: show briefly on movement
    let cursorTimer = null;
    window.addEventListener("mousemove", () => {
      document.body.style.cursor = "default";
      clearTimeout(cursorTimer);
      cursorTimer = setTimeout(() => { document.body.style.cursor = "none"; }, 1200);
    });
  </script>
</body>
</html>
